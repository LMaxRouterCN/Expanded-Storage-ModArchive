name: Auto Release from Issue

on:
  issues:
    types: [opened]

jobs:
  create-release:
    if: github.event.action == 'opened' && startsWith(github.event.issue.title, '[Upload]')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Parse version from issue title
        id: parse_version
        run: |
          # 示例标题: "[Upload] MC1.20.1-NeoForge-47.1.0-v2.3.1"
          title="${{ github.event.issue.title }}"
          part1=$(echo "$title" | cut -d'-' -f1)
          part2=$(echo "$title" | cut -d'-' -f2)
          part3=$(echo "$title" | cut -d'-' -f3)
          part4=$(echo "$title" | cut -d'-' -f4)
          mc_version=$(echo "$part1" | sed 's/.*MC//')
          loader="$part2"
          loader_version="$part3"
          mod_version=$(echo "$part4" | sed 's/.*v//')
          if [ -z "$mc_version" ] || [ -z "$loader" ] || [ -z "$loader_version" ] || [ -z "$mod_version" ]; then
            echo "Error: Failed to parse version from title. Please check the format."
            exit 1
          fi
          echo "mc_version=$mc_version" >> $GITHUB_OUTPUT
          echo "loader=$loader" >> $GITHUB_OUTPUT
          echo "loader_version=$loader_version" >> $GITHUB_OUTPUT
          echo "mod_version=$mod_version" >> $GITHUB_OUTPUT
          echo "tag_name=mc${mc_version}-${loader}-${loader_version}-v${mod_version}" >> $GITHUB_OUTPUT

      - name: Download and rename mod file from issue
        id: download_file
        run: |
          # 获取第一个附件的 URL
          asset_url=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/assets" | jq -r '.[0].url')
          if [ -z "$asset_url" ] || [ "$asset_url" = "null" ]; then
            echo "No asset found in the issue. Exiting."
            exit 1
          fi
          echo "Downloading asset from: $asset_url"
          # 下载文件，并保存为 .zip 后缀
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/octet-stream" "$asset_url" -o mod_file.zip
          
          # 【关键步骤】将 .zip 文件重命名为 .jar
          mv mod_file.zip mod_file.jar
          
          echo "filename=mod_file.jar" >> $GITHUB_OUTPUT

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.parse_version.outputs.tag_name }}
          name: "MC ${{ steps.parse_version.outputs.mc_version }} - ${{ steps.parse_version.outputs.loader }} ${{ steps.parse_version.outputs.loader_version }} - v${ steps.parse_version.outputs.mod_version }}"
          body: |
            此版本由社区成员 @${{ github.event.issue.user.login }} 贡献。
            
            **环境信息:**
            - Minecraft: `${{ steps.parse_version.outputs.mc_version }}`
            - 加载器: `${{ steps.parse_version.outputs.loader }} ${{ steps.parse_version.outputs.loader_version }}`
            - 模组版本: `${{ steps.parse_version.outputs.mod_version }}`
            
            ---
            **原始 Issue 信息:**
            ${{ github.event.issue.body }}
          files: ${{ steps.download_file.outputs.filename }}
          draft: false
          prerelease: false

      - name: Comment on Issue
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ 感谢您的贡献！Release 已自动创建: [查看 Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.parse_version.outputs.tag_name }}) \n\n 这个 Issue 将被自动关闭。`
            });

      - name: Close Issue
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });

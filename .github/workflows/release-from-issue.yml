name: Mod File Uploader

on:
  issues:
    types: [opened]

jobs:
  process-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      actions: read

    steps:
      - name: Validate issue
        id: validate
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«.zipé™„ä»¶
            const zipAttachments = body.match(/!\[[^\]]*\]\(([^)]+\.zip)\)/g);
            if (!zipAttachments || zipAttachments.length === 0) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âŒ æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„.zipé™„ä»¶\n\nè¯·æŒ‰æ¨¡æ¿è¦æ±‚å°†.jaræ–‡ä»¶é‡å‘½åä¸º**.jar.zip**åé‡æ–°ä¸Šä¼ `
              });
              await github.rest.issues.update({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed'
              });
              core.setFailed('No valid zip attachment found');
              return;
            }
            
            // æå–ç¬¬ä¸€ä¸ªæœ‰æ•ˆURL
            const match = zipAttachments[0].match(/\(([^)]+\.zip)\)/);
            const fileUrl = match[1];
            const originalName = decodeURIComponent(fileUrl.split('/').pop().split('?')[0]);
            
            // éªŒè¯æ–‡ä»¶åæ ¼å¼
            if (!originalName.endsWith('.jar.zip')) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âŒ æ— æ•ˆçš„æ–‡ä»¶åæ ¼å¼\n\nè¯·å°†æ–‡ä»¶é‡å‘½åä¸º **.jar.zip** åç¼€ï¼ˆä¾‹å¦‚ï¼šmod.jar.zipï¼‰`
              });
              await github.rest.issues.update({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed'
              });
              core.setFailed('Invalid filename format');
              return;
            }
            
            core.setOutput('file_url', fileUrl);
            core.setOutput('original_name', originalName);
            core.setOutput('jar_name', originalName.replace(/\.zip$/, ''));

      - name: Download attachment
        if: steps.validate.outcome == 'success'
        env:
          FILE_URL: ${{ steps.validate.outputs.file_url }}
        run: |
          curl -L \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/octet-stream" \
            "$FILE_URL" \
            -o "${{ steps.validate.outputs.original_name }}"

      - name: Rename to JAR
        if: steps.validate.outcome == 'success'
        run: |
          mv "${{ steps.validate.outputs.original_name }}" "${{ steps.validate.outputs.jar_name }}"

      - name: Create release
        id: create_release
        if: steps.validate.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { createReadStream } = require('fs');
            const { join } = require('path');
            
            // ç”Ÿæˆå”¯ä¸€Releaseåç§°
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const tagName = `upload-${timestamp}`;
            const releaseName = `Mod Upload (${timestamp})`;
            const jarFile = join(process.cwd(), '${{ steps.validate.outputs.jar_name }}');
            
            // åˆ›å»ºRelease
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: releaseName,
              body: `Uploaded via issue #${context.issue.number}\n\nâš ï¸ **æ³¨æ„**ï¼šåªæœ‰ä»“åº“ç®¡ç†å‘˜å¯ä»¥åˆ é™¤æ­¤æ–‡ä»¶`,
              draft: false,
              prerelease: false
            });
            
            // ä¸Šä¼ JARæ–‡ä»¶
            const fileStream = createReadStream(jarFile);
            const contentLength = fs.statSync(jarFile).size;
            
            const asset = await github.rest.repos.uploadReleaseAsset({
              url: release.data.upload_url,
              headers: {
                'content-length': contentLength,
                'content-type': 'application/java-archive'
              },
              name: '${{ steps.validate.outputs.jar_name }}',
              data: fileStream
            });
            
            core.setOutput('release_url', release.data.html_url);
            core.setOutput('download_url', asset.data.browser_download_url);

      - name: Comment success
        if: steps.create_release.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const downloadUrl = `${{ steps.create_release.outputs.download_url }}`;
            const releaseUrl = `${{ steps.create_release.outputs.release_url }}`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… ä¸Šä¼ æˆåŠŸï¼\n\nğŸ“¥ ä¸‹è½½é“¾æ¥: [${{ steps.validate.outputs.jar_name }}](${downloadUrl})\n\nğŸ“¦ Releaseé¡µé¢: [æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶](${releaseUrl})`
            });
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });

      - name: Cleanup
        if: always()
        run: |
          rm -f *.zip *.jar || true

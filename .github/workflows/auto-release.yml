name: Auto Release from Issue

on:
  issues:
    types: [opened]

jobs:
  create-release:
    # 只在 issue 被打开且带有 'file-upload' 标签时运行
    if: github.event.action == 'opened' && contains(github.event.issue.labels.*.name, 'file-upload')
    runs-on: ubuntu-latest
    permissions:
      contents: write # 授予写入内容的权限，以创建 Release
      issues: write   # 授予写入 issue 的权限，以添加评论和关闭 Issue

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Parse version from issue title
        id: parse_version
        run: |
          # 示例标题: "[Upload] MC1.20.1-NeoForge-47.1.0-v2.3.1"
          title="${{ github.event.issue.title }}"
          
          # 使用 cut 命令按 '-' 分割字符串，非常稳健
          part1=$(echo "$title" | cut -d'-' -f1)
          part2=$(echo "$title" | cut -d'-' -f2)
          part3=$(echo "$title" | cut -d'-' -f3)
          part4=$(echo "$title" | cut -d'-' -f4)
          
          # 提取 MC 版本
          mc_version=$(echo "$part1" | sed 's/.*MC//')
          # 提取加载器
          loader="$part2"
          # 提取加载器版本
          loader_version="$part3"
          # 提取模组版本
          mod_version=$(echo "$part4" | sed 's/.*v//')
          
          # 校验是否解析成功
          if [ -z "$mc_version" ] || [ -z "$loader" ] || [ -z "$loader_version" ] || [ -z "$mod_version" ]; then
            echo "Error: Failed to parse version from title. Please check the format."
            echo "Expected format: [Upload] MC<version>-<loader>-<loader_version>-v<mod_version>"
            exit 1
          fi
          
          echo "mc_version=$mc_version" >> $GITHUB_OUTPUT
          echo "loader=$loader" >> $GITHUB_OUTPUT
          echo "loader_version=$loader_version" >> $GITHUB_OUTPUT
          echo "mod_version=$mod_version" >> $GITHUB_OUTPUT
          echo "tag_name=mc${mc_version}-${loader}-${loader_version}-v${mod_version}" >> $GITHUB_OUTPUT

      - name: Download mod file from issue
        id: download_file
        run: |
          # 获取第一个附件的 URL
          asset_url=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/assets" | jq -r '.[0].url')
          if [ -z "$asset_url" ] || [ "$asset_url" = "null" ]; then
            echo "No asset found in the issue. Exiting."
            exit 1
          fi
          echo "Downloading asset from: $asset_url"
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/octet-stream" "$asset_url" -o mod_file.jar
          echo "filename=mod_file.jar" >> $GITHUB_OUTPUT

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.parse_version.outputs.tag_name }}
          name: "MC ${{ steps.parse_version.outputs.mc_version }} - ${{ steps.parse_version.outputs.loader }} ${{ steps.parse_version.outputs.loader_version }} - v${ steps.parse_version.outputs.mod_version }}"
          body: |
            此版本由社区成员 @${{ github.event.issue.user.login }} 贡献。
            
            **环境信息:**
            - Minecraft: `${{ steps.parse_version.outputs.mc_version }}`
            - 加载器: `${{ steps.parse_version.outputs.loader }} ${{ steps.parse_version.outputs.loader_version }}`
            - 模组版本: `${{ steps.parse_version.outputs.mod_version }}`
            
            ---
            **原始 Issue 信息:**
            ${{ github.event.issue.body }}
          files: ${{ steps.download_file.outputs.filename }}
          draft: false
          prerelease: false

      - name: Comment on Issue
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ 感谢您的贡献！Release 已自动创建: [查看 Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.parse_version.outputs.tag_name }}) \n\n 这个 Issue 将被自动关闭。`
            });

      - name: Close Issue
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });

# .github/workflows/mod_uploader.yml
name: Mod File Uploader - FINAL

on:
  issues:
    types: [opened]

env:
  MAX_FILE_SIZE: 524288000  # 500MB

jobs:
  process-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Extract attachment URL
        id: extract_attachment
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            const title = issue.title || '';
            
            // è°ƒè¯•ä¿¡æ¯
            console.log('=== è°ƒè¯•ä¿¡æ¯ ===');
            console.log('æ ‡é¢˜:', title);
            console.log('æ­£æ–‡é¢„è§ˆ (å‰200å­—ç¬¦):', body.substring(0, 200));
            console.log('=== è°ƒè¯•ç»“æŸ ===');
            
            // 1. éªŒè¯æ¨¡æ¿ä½¿ç”¨
            const usesTemplate = 
              title.includes('[UPLOAD]') || 
              body.includes('é‡è¦æç¤º') || 
              body.includes('é‡å‘½åä¸º **.jar.zip**');
            
            if (!usesTemplate) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âŒ **æœªä½¿ç”¨æ­£ç¡®æ¨¡æ¿**\n\nè¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹æ­¥éª¤:\n1. ç‚¹å‡»ä»“åº“çš„"Issues"æ ‡ç­¾\n2. ç‚¹å‡»ç»¿è‰²çš„"New Issue"æŒ‰é’®\n3. **é€‰æ‹©"ä¸Šä¼ æ¨¡ç»„æ–‡ä»¶"æ¨¡æ¿** (ä¸æ˜¯"Open a blank issue")\n4. æŒ‰ç…§æ¨¡æ¿æŒ‡å¼•æ“ä½œ`
              });
              await github.rest.issues.update({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed'
              });
              core.setFailed('Invalid template usage');
              return;
            }
            
            // 2. ä»æ­£æ–‡æå–æ‰€æœ‰URL (å…³é”®ä¿®å¤)
            const urls = [];
            
            // ç­–ç•¥1: åŒ¹é…Markdownå›¾ç‰‡/é“¾æ¥è¯­æ³•
            const markdownRegex = /!\[[^\]]*\]\(([^)]+?)\)|\[[^\]]*\]\(([^)]+?)\)/g;
            let match;
            while ((match = markdownRegex.exec(body)) !== null) {
              const url = match[1] || match[2];
              if (url && url.includes('.zip')) {
                urls.push(url);
              }
            }
            
            // ç­–ç•¥2: åŒ¹é…çº¯URL (GitHubæ–°é™„ä»¶æ ¼å¼)
            const urlRegex = /(https?:\/\/[^\s)]+?\.zip[^\s)]*)/ig;
            const pureUrls = body.match(urlRegex) || [];
            urls.push(...pureUrls);
            
            console.log('æ£€æµ‹åˆ°çš„URL:', urls);
            
            if (urls.length === 0) {
              // æä¾›è¯¦ç»†æŒ‡å¯¼
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âŒ **æœªæ£€æµ‹åˆ°.zipæ–‡ä»¶**\n\n**æ­£ç¡®ä¸Šä¼ æ­¥éª¤**:\n1. å°†æ–‡ä»¶é‡å‘½åä¸º \`æ–‡ä»¶å.jar.zip\`\n2. **ç›´æ¥æ‹–æ‹½**æ–‡ä»¶åˆ°è¯„è®ºæ¡† (ä¸æ˜¯ç‚¹å‡»æŒ‰é’®)\n3. **ç­‰å¾…ä¸Šä¼ å®Œæˆ** (çœ‹åˆ°æ–‡ä»¶åå‡ºç°åœ¨è¯„è®ºæ¡†)\n4. æäº¤Issue\n\nâ„¹ï¸ æ‚¨çš„æ–‡ä»¶åº”æ˜¾ç¤ºä¸ºç±»ä¼¼:\n\`https://github.com/user-attachments/files/.../filename.jar.zip\``
              });
              await github.rest.issues.update({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed'
              });
              core.setFailed('No zip URLs found');
              return;
            }
            
            // 3. é€‰æ‹©ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„.zip URL
            let fileUrl = urls.find(url => url.toLowerCase().includes('.jar.zip')) || urls[0];
            fileUrl = fileUrl.trim();
            
            // 4. ä¿®å¤ç‰¹æ®Šå­—ç¬¦ (å…³é”®!)
            fileUrl = fileUrl
              .replace(/%2B/g, '+')
              .replace(/%20/g, ' ')
              .replace(/&amp;/g, '&')
              .replace(/&#43;/g, '+');
            
            // 5. å¤„ç†GitHubä»£ç†URL
            if (fileUrl.includes('user-attachments.githubusercontent.com')) {
              fileUrl = fileUrl.replace(
                'https://user-attachments.githubusercontent.com/',
                'https://github.com/'
              );
            } else if (fileUrl.includes('private-user-attachments')) {
              fileUrl = fileUrl.replace(
                'https://private-user-attachments.githubusercontent.com/',
                'https://github.com/'
              );
            }
            
            // 6. æå–æ–‡ä»¶å
            let originalName = '';
            try {
              // ä¼˜å…ˆä»URLå‚æ•°è·å–
              const urlObj = new URL(fileUrl, 'https://github.com');
              const params = new URLSearchParams(urlObj.search);
              
              if (params.has('name')) {
                originalName = decodeURIComponent(params.get('name'));
              } else {
                // ä»è·¯å¾„æå–
                const path = urlObj.pathname;
                originalName = decodeURIComponent(path.substring(path.lastIndexOf('/') + 1));
              }
            } catch (e) {
              console.log('URLè§£æå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•');
              // ä»å­—ç¬¦ä¸²æå–
              const match = fileUrl.match(/\/([^\/?]+?)(?:\?|$)/);
              originalName = match ? match[1].replace(/\+/g, ' ') : 'unknown.zip';
            }
            
            // 7. æ™ºèƒ½æ–‡ä»¶åä¿®å¤
            const lowerName = originalName.toLowerCase();
            let cleanedName = originalName;
            
            if (!lowerName.endsWith('.zip')) {
              // æ·»åŠ .zipåç¼€
              cleanedName += '.zip';
            }
            
            if (!lowerName.includes('.jar')) {
              // æ’å…¥.jar (åœ¨.zipå‰)
              const base = cleanedName.substring(0, cleanedName.length - 4);
              cleanedName = base + '.jar.zip';
            }
            
            console.log('æœ€ç»ˆæ–‡ä»¶å:', cleanedName);
            
            // 8. è·å–æ–‡ä»¶å¤§å°
            let contentLength = 0;
            try {
              const headers = { 
                'Authorization': `Bearer ${{ secrets.GITHUB_TOKEN }}`,
                'User-Agent': 'Mozilla/5.0 (compatible; GitHub-Actions)'
              };
              
              const response = await fetch(fileUrl, {
                method: 'HEAD',
                headers,
                redirect: 'follow'
              });
              
              if (response.ok) {
                contentLength = parseInt(response.headers.get('content-length') || '0');
              }
            } catch (error) {
              console.log('HEADè¯·æ±‚å¤±è´¥:', error.message);
            }
            
            // è®¾ç½®è¾“å‡º
            core.setOutput('file_url', fileUrl);
            core.setOutput('original_name', cleanedName);
            core.setOutput('jar_name', cleanedName.replace(/\.zip$/i, '.jar'));
            core.setOutput('file_size', contentLength || 1024);
            core.setOutput('debug_urls', urls.join(', '));

      - name: Download file
        env:
          FILE_URL: ${{ steps.extract_attachment.outputs.file_url }}
          OUTPUT_NAME: ${{ steps.extract_attachment.outputs.original_name }}
        run: |
          echo "ä¸‹è½½URL: $FILE_URL"
          echo "ä¿å­˜ä¸º: $OUTPUT_NAME"
          
          # åˆ›å»ºå®‰å…¨æ–‡ä»¶å
          SAFE_NAME=$(echo "$OUTPUT_NAME" | tr -cd 'a-zA-Z0-9._-')
          [ -z "$SAFE_NAME" ] && SAFE_NAME="mod.jar.zip"
          
          # ä½¿ç”¨curlä¸‹è½½
          curl -L \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/octet-stream" \
            --retry 3 \
            --retry-delay 5 \
            --max-time 300 \
            -o "$SAFE_NAME" \
            "$FILE_URL"
          
          # éªŒè¯æ–‡ä»¶
          if [ ! -f "$SAFE_NAME" ]; then
            echo "âŒ ä¸‹è½½å¤±è´¥"
            ls -la
            exit 1
          fi
          
          # é‡å‘½å
          mv "$SAFE_NAME" "$OUTPUT_NAME"
          echo "ä¸‹è½½å®Œæˆ: $(stat -c%s "$OUTPUT_NAME") å­—èŠ‚"

      - name: Verify ZIP integrity
        id: verify_zip
        run: |
          FILE="${{ steps.extract_attachment.outputs.original_name }}"
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          size=$(stat -c%s "$FILE")
          echo "æ–‡ä»¶å¤§å°: $size å­—èŠ‚"
          
          if [ "$size" -gt "${{ env.MAX_FILE_SIZE }}" ]; then
            echo "âŒ æ–‡ä»¶è¶…è¿‡500MBé™åˆ¶"
            exit 1
          fi
          
          if [ "$size" -eq 0 ]; then
            echo "âŒ ç©ºæ–‡ä»¶"
            exit 1
          fi
          
          # éªŒè¯ZIP
          if ! unzip -t "$FILE" > /dev/null 2>&1; then
            echo "âŒ æ— æ•ˆçš„ZIPæ–‡ä»¶"
            unzip -t "$FILE" 2>&1
            exit 1
          fi
          
          # è®¡ç®—SHA256
          sha256=$(sha256sum "$FILE" | awk '{print $1}')
          echo "sha256_hash=$sha256" >> $GITHUB_OUTPUT
          echo "çŸ­å“ˆå¸Œ: ${sha256:0:8}"

      - name: Check duplicates
        id: check_duplicates
        uses: actions/github-script@v7
        with:
          script: |
            const sha256 = '${{ steps.verify_zip.outputs.sha256_hash }}';
            const shortHash = sha256.substring(0, 8);
            
            try {
              // æ£€æŸ¥é‡å¤
              await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: `sha256-${sha256}`
              });
              
              // è·å–ç°æœ‰æ–‡ä»¶
              const releases = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              const release = releases.data.find(r => r.tag_name === `sha256-${sha256}`);
              if (release) {
                const jar = release.assets.find(a => a.name.endsWith('.jar'));
                if (jar) {
                  await github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: `ğŸ”„ **é‡å¤æ–‡ä»¶**\n\næ­¤æ–‡ä»¶å·²å­˜åœ¨:\nğŸ“¥ [${jar.name}](${jar.browser_download_url})\nğŸ”– å“ˆå¸Œ: \`${shortHash}...\``
                  });
                  await github.rest.issues.update({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    state: 'closed'
                  });
                  core.setOutput('duplicate', 'true');
                  core.setOutput('download_url', jar.browser_download_url);
                  core.setOutput('short_hash', shortHash);
                  return;
                }
              }
            } catch (error) {
              if (error.status !== 404) {
                console.log('æ£€æŸ¥é‡å¤æ—¶å‡ºé”™:', error.message);
              }
            }
            
            core.setOutput('duplicate', 'false');
            core.setOutput('short_hash', shortHash);

      - name: Create release
        if: steps.check_duplicates.outputs.duplicate == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { createReadStream } = require('fs');
            const { basename } = require('path');
            
            const tagName = `sha256-${{ steps.verify_zip.outputs.sha256_hash }}`;
            const releaseName = `Mod Upload - ${{ steps.check_duplicates.outputs.short_hash }}`;
            const jarFile = '${{ steps.extract_attachment.outputs.jar_name }}';
            const jarName = basename(jarFile);
            
            // é‡å‘½å
            fs.renameSync('${{ steps.extract_attachment.outputs.original_name }}', jarFile);
            
            // åˆ›å»ºRelease
            const {  release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: releaseName,
              body: `âœ… ä¸Šä¼ è‡ª Issue #${context.issue.number}\n\nâš ï¸ ä»…ä»“åº“ç®¡ç†å‘˜å¯åˆ é™¤æ­¤æ–‡ä»¶`,
              draft: false,
              prerelease: false
            });
            
            // ä¸Šä¼ æ–‡ä»¶
            const asset = await github.rest.repos.uploadReleaseAsset({
              url: release.upload_url,
              headers: {
                'content-length': fs.statSync(jarFile).size,
                'content-type': 'application/java-archive'
              },
              name: jarName,
               createReadStream(jarFile)
            });
            
            core.setOutput('release_url', release.html_url);
            core.setOutput('download_url', asset.browser_download_url);

      - name: Comment success
        if: steps.check_duplicates.outputs.duplicate == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **ä¸Šä¼ æˆåŠŸ!**\n\nğŸ“¥ [ä¸‹è½½æ–‡ä»¶](${{ steps.create_release.outputs.download_url }})\nğŸ“¦ [æ‰€æœ‰æ–‡ä»¶](${{ steps.create_release.outputs.release_url }})\nğŸ”– å“ˆå¸Œ: \`${{ steps.check_duplicates.outputs.short_hash }}...\``
            });
            await github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });

      - name: Cleanup
        if: always()
        run: |
          echo "æ¸…ç†æ–‡ä»¶..."
          rm -f *.zip *.jar || true
          echo "æ¸…ç†å®Œæˆ"

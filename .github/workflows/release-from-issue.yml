name: Create Release from Issue Upload

# è§¦å‘æ¡ä»¶ï¼šå½“ä¸€ä¸ªæ–°çš„ Issue è¢«æ‰“å¼€æ—¶
on:
  issues:
    types: [opened]

# æƒé™è®¾ç½®ï¼šéœ€è¦å†™å…¥å†…å®¹å’Œè¯„è®º Issue çš„æƒé™
permissions:
  contents: write
  issues: write

jobs:
  create-release:
    # å¦‚æœ Issue ä¸æ˜¯ç”± 'upload' æ ‡ç­¾åˆ›å»ºçš„ï¼Œåˆ™è·³è¿‡
    if: contains(github.event.issue.labels.*.name, 'upload')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse Issue Body and Extract Info
        id: parse_issue
        run: |
          # å°† Issue Body å†…å®¹å­˜å…¥å˜é‡
          BODY="${{ github.event.issue.body }}"

          # ä½¿ç”¨ sed æå–æ¨¡ç»„ç‰ˆæœ¬
          MOD_VERSION=$(echo "$BODY" | sed -n '/### æ¨¡ç»„ç‰ˆæœ¬/,/###/p' | sed '1d;$d' | xargs)
          echo "mod_version=$MOD_VERSION" >> $GITHUB_OUTPUT

          # ä½¿ç”¨ sed æå– Minecraft ç‰ˆæœ¬
          MC_VERSION=$(echo "$BODY" | sed -n '/### Minecraft ç‰ˆæœ¬/,/###/p' | sed '1d;$d' | xargs)
          echo "mc_version=$MC_VERSION" >> $GITHUB_OUTPUT

          # ä½¿ç”¨ sed æå–æ¨¡ç»„åŠ è½½å™¨
          MOD_LOADER=$(echo "$BODY" | sed -n '/### æ¨¡ç»„åŠ è½½å™¨/,/###/p' | sed '1d;$d' | xargs)
          echo "mod_loader=$MOD_LOADER" >> $GITHUB_OUTPUT
          
          # ä½¿ç”¨ sed æå–æ›´æ–°æ—¥å¿—
          RELEASE_NOTES=$(echo "$BODY" | sed -n '/### æ›´æ–°æ—¥å¿—/,/###/p' | sed '1d;$d' | xargs)
          # å¯¹æ¢è¡Œç¬¦è¿›è¡Œè½¬ä¹‰ï¼Œä»¥ä¾¿åœ¨ gh release å‘½ä»¤ä¸­ä½¿ç”¨
          RELEASE_NOTES_ESCAPED=$(echo "$RELEASE_NOTES" | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "release_notes=$RELEASE_NOTES_ESCAPED" >> $GITHUB_OUTPUT

          # æ£€æŸ¥æ˜¯å¦æœ‰é™„ä»¶
          ASSET_JSON=$(echo '${{ github.event.issue.assets }}' | jq -r '.[0]')
          if [ "$ASSET_JSON" == "null" ]; then
            echo "ERROR: No file asset found in the issue."
            gh issue comment ${{ github.event.issue.number }} --body "âŒ **é”™è¯¯**: æœªåœ¨ Issue ä¸­æ‰¾åˆ°ä¸Šä¼ çš„æ–‡ä»¶ã€‚è¯·ç¡®ä¿ä½ å·²ç»å°† `.jar.zip` æ–‡ä»¶æ‹–æ‹½åˆ°ä¸Šä¼ åŒºåŸŸã€‚"
            exit 1
          fi
          
          # è·å–é™„ä»¶åç§°å’Œä¸‹è½½URL
          ASSET_NAME=$(echo "$ASSET_JSON" | jq -r '.name')
          ASSET_URL=$(echo "$ASSET_JSON" | jq -r '.browser_download_url')
          
          echo "asset_name=$ASSET_NAME" >> $GITHUB_OUTPUT
          echo "asset_url=$ASSET_URL" >> $GITHUB_OUTPUT

      - name: Download and Rename Asset
        run: |
          # ä¸‹è½½æ–‡ä»¶
          wget -O "${{ steps.parse_issue.outputs.asset_name }}" "${{ steps.parse_issue.outputs.asset_url }}"
          
          # æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦ä»¥ .jar.zip ç»“å°¾
          ORIGINAL_FILENAME="${{ steps.parse_issue.outputs.asset_name }}"
          if [[ "$ORIGINAL_FILENAME" != *.jar.zip ]]; then
            echo "ERROR: Uploaded file does not end with .jar.zip"
            gh issue comment ${{ github.event.issue.number }} --body "âŒ **é”™è¯¯**: ä¸Šä¼ çš„æ–‡ä»¶åä¸æ­£ç¡®ã€‚è¯·ç¡®ä¿ä½ çš„æ–‡ä»¶åä»¥ `.jar.zip` ç»“å°¾ã€‚å½“å‰æ–‡ä»¶å: \`$ORIGINAL_FILENAME\`"
            exit 1
          fi
          
          # å»æ‰æœ«å°¾çš„ .zip
          FINAL_FILENAME="${ORIGINAL_FILENAME%.zip}"
          mv "$ORIGINAL_FILENAME" "$FINAL_FILENAME"
          echo "final_filename=$FINAL_FILENAME" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        run: |
          # æ„å»ºå‘å¸ƒè¯´æ˜
          NOTES="**æ¨¡ç»„ç‰ˆæœ¬:** ${{ steps.parse_issue.outputs.mod_version }}\n**Minecraft ç‰ˆæœ¬:** ${{ steps.parse_issue.outputs.mc_version }}\n**æ¨¡ç»„åŠ è½½å™¨:** ${{ steps.parse_issue.outputs.mod_loader }}\n\n---\n\n${{ steps.parse_issue.outputs.release_notes }}"
          
          # åˆ›å»º Release
          gh release create "v${{ steps.parse_issue.outputs.mod_version }}" "$FINAL_FILENAME" \
            --title "Expanded Storage v${{ steps.parse_issue.outputs.mod_version }} for ${{ steps.parse_issue.outputs.mc_version }}" \
            --notes "$NOTES" \
            --latest

      - name: Comment on Issue with Success Message
        run: |
          RELEASE_URL="${{ github.server_url }}/${{ github.repository }}/releases/v${{ steps.parse_issue.outputs.mod_version }}"
          gh issue comment ${{ github.event.issue.number }} --body "âœ… **ä¸Šä¼ æˆåŠŸ!** \n\næ¨¡ç»„æ–‡ä»¶å·²è‡ªåŠ¨å¤„ç†å¹¶åˆ›å»ºä¸ºä¸€ä¸ªæ–°çš„ Releaseã€‚\n\nğŸ”— [æŸ¥çœ‹ Release here]($RELEASE_URL)"
